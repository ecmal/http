{"version":3,"file":"server.js","sourceRoot":"","sources":["server.ts"],"names":[],"mappings":"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","sourcesContent":["'use strict';\nimport {Base} from './base';\nimport {HttpParser} from './http_parser';\nimport {Hybi} from './hybi';\n\n\n\nexport class Server  extends Base {\n    static isWebSocket(request) {\n        if (request.method !== 'GET'){\n            return false;\n        }\n        let connection = request.headers.connection || '',\n            upgrade    = request.headers.upgrade || '';\n\n        return (\n            connection.toLowerCase().split(/\\s*,\\s*/).indexOf('upgrade') >= 0 &&\n            upgrade.toLowerCase() === 'websocket'\n        );\n    }\n    static isSecureRequest(request) {\n        if (request.connection && request.connection.authorized !== undefined) return true;\n        if (request.socket && request.socket.secure) return true;\n\n        var headers = request.headers;\n        if (!headers) return false;\n        if (headers['https'] === 'on') return true;\n        if (headers['x-forwarded-ssl'] === 'on') return true;\n        if (headers['x-forwarded-scheme'] === 'https') return true;\n        if (headers['x-forwarded-proto'] === 'https') return true;\n\n        return false;\n    }\n    static determineUrl(request) {\n        var scheme = this.isSecureRequest(request) ? 'wss:' : 'ws:';\n        return scheme + '//' + request.headers.host + request.url;\n    }\n    static http(request, options?):Base {\n        options = options || {};\n        if (options.requireMasking === undefined) options.requireMasking = true;\n        var headers = request.headers,\n            url     = this.determineUrl(request);\n        if (headers['sec-websocket-version']){\n            return new Hybi(request, url, options);\n        }else{\n            throw new Error('Unsupported WebSocket version');\n        }\n\n    }\n    public EVENTS = ['open', 'message', 'error', 'close'];\n    public method:string;\n    public headers:string;\n    public body:string;\n    public protocol:string;\n    public version:string;\n\n    private _http:HttpParser;\n    private _delegate:any;\n\n    constructor(options) {\n        super(null, null, (()=>{\n            options = options || {};\n            if (options.requireMasking === undefined){\n                options.requireMasking = true;\n            }\n            return options;\n        })());\n        this._http = new HttpParser('request');\n    }\n\n    public parse(chunk) {\n        if (this._delegate) return this._delegate.parse(chunk);\n\n        this._http.parse(chunk);\n        if (!this._http.isComplete()) return;\n\n        this.method  = this._http.method;\n        this.url     = this._http.url;\n        this.headers = this._http.headers;\n        this.body    = this._http.body;\n\n        var self = this;\n        this._delegate = Server.http(this, this._options);\n        this._delegate.messages = this.messages;\n        this._delegate.io = this.io;\n        this._open();\n\n        this.EVENTS.forEach(function(event) {\n            this._delegate.on(event, function(e) { self.emit(event, e) });\n        }, this);\n\n        this.protocol = this._delegate.protocol;\n        this.version  = this._delegate.version;\n\n        this.parse(this._http.body);\n        this.emit('connect', new Base.ConnectEvent());\n    }\n    protected _bindEventListeners() {\n        this.messages.on('error', function() {});\n        this.on('error', function() {});\n    }\n    protected _open() {\n        this.__queue.forEach(function(msg) {\n            this._delegate[msg[0]].apply(this._delegate, msg[1]);\n        }, this);\n        this.__queue = [];\n    }\n}\n\n\n['addExtension', 'setHeader', 'start', 'frame', 'text', 'binary', 'ping', 'close'].forEach(function(method) {\n    Server.prototype[method] = function() {\n        if (this._delegate) {\n            return this._delegate[method].apply(this._delegate, arguments);\n        } else {\n            this.__queue.push([method, arguments]);\n            return true;\n        }\n    };\n});\n\n\n"]}