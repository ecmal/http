{"version":3,"file":"hybi.js","sourceRoot":"","sources":["hybi.ts"],"names":[],"mappings":"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","sourcesContent":["import {Base} from \"./base\";\nimport {createHash, randomBytes} from \"node/crypto\";\nimport {Extensions} from \"./extensions\";\nimport {Frame} from \"./hybi/frame\";\nimport {Message} from \"./hybi/message\";\n\n\nexport class Hybi extends Base {\n    static GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n\n    static mask(payload, mask, offset?) {\n        if (!mask || mask.length === 0) return payload;\n        offset = offset || 0;\n\n        for (let i = 0, n = payload.length - offset; i < n; i++) {\n            payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n        }\n        return payload;\n    }\n\n    static generateAccept(key) {\n        let sha1 = createHash('sha1');\n        sha1.update(key + Hybi.GUID);\n        return sha1.digest('base64');\n    }\n\n    //\n    FIN = 0x80;\n    MASK = 0x80;\n    RSV1 = 0x40;\n    RSV2 = 0x20;\n    RSV3 = 0x10;\n    OPCODE = 0x0F;\n    LENGTH = 0x7F;\n    OPCODES = {\n        continuation: 0,\n        text: 1,\n        binary: 2,\n        close: 8,\n        ping: 9,\n        pong: 10\n    };\n    OPCODE_CODES = [0, 1, 2, 8, 9, 10];\n    MESSAGE_OPCODES = [0, 1, 2];\n    OPENING_OPCODES = [1, 2];\n    ERRORS = {\n        normal_closure: 1000,\n        going_away: 1001,\n        protocol_error: 1002,\n        unacceptable: 1003,\n        encoding_error: 1007,\n        policy_violation: 1008,\n        too_large: 1009,\n        extension_error: 1010,\n        unexpected_condition: 1011\n    };\n    ERROR_CODES = [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011];\n    DEFAULT_ERROR_CODE = 1000;\n    MIN_RESERVED_ERROR = 3000;\n    MAX_RESERVED_ERROR = 4999;\n    UTF8_MATCH = /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/;\n    //\n    public key:string;\n    public protocol:string;\n    public version:string;\n\n    protected _extensions:Extensions;\n    protected _masking:any;\n    protected _protocols:string[];\n    protected _requireMasking:any;\n    protected _pingCallbacks:any;\n    protected _frame:Frame;\n    protected _message:Message;\n\n    constructor(request, url, options) {\n        super(request, url, options);\n        this._extensions = new Extensions();\n        this._stage = 0;\n        this._masking = this._options.masking;\n        this._requireMasking = this._options.requireMasking;\n        this._pingCallbacks = {};\n\n        if (typeof this._options.protocols === 'string') {\n            this._protocols = this._options.protocols.split(/\\s*,\\s*/);\n        } else {\n            this._protocols = this._options.protocols || [];\n        }\n\n\n        if (!this._request) return;\n\n        let secKey = this._request.headers['sec-websocket-key'],\n            protos = this._request.headers['sec-websocket-protocol'],\n            version = this._request.headers['sec-websocket-version'],\n            supported = this._protocols;\n        this.key = secKey;\n        this._headers.set('Upgrade', 'websocket');\n        this._headers.set('Connection', 'Upgrade');\n        this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n        if (protos !== undefined) {\n            if (typeof protos === 'string') {\n                protos = protos.split(/\\s*,\\s*/);\n            }\n            this.protocol = protos.filter(function (p) {\n                return supported.indexOf(p) >= 0\n            })[0];\n            if (this.protocol) {\n                this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n            }\n        }\n\n        this.version = 'hybi-' + version;\n    }\n\n    public addExtension(extension) {\n        this._extensions.add(extension);\n        return true;\n    }\n\n    public parse(chunk) {\n        //console.info(\"<<<\", createHash('md5').update(chunk).digest(\"hex\"), chunk);\n        this._reader.put(chunk);\n        let buffer = true;\n        while (buffer) {\n            switch (this._stage) {\n                case 0:\n                    buffer = this._reader.read(1);\n                    if (buffer){\n                        this._parseOpcode(buffer[0]);\n                    }\n                    break;\n                case 1:\n                    buffer = this._reader.read(1);\n                    if (buffer){\n                        this._parseLength(buffer[0]);\n                    }\n                    break;\n                case 2:\n                    buffer = this._reader.read(this._frame.lengthBytes);\n                    if (buffer){\n                        this._parseExtendedLength(buffer);\n                    }\n                    break;\n                case 3:\n                    buffer = this._reader.read(4);\n                    if (buffer) {\n                        this._stage = 4;\n                        this._frame.maskingKey = buffer;\n                    }\n                    break;\n                case 4:\n                    buffer = this._reader.read(this._frame.length);\n                    if (buffer) {\n                        this._stage = 0;\n                        this._emitFrame(buffer);\n                    }\n                    break;\n                default:\n                    buffer = null;\n            }\n        }\n    }\n    public text(message):boolean {\n        if (this.readyState > 1){\n            return false;\n        }\n        return this.frame(message, 'text');\n    }\n    public binary(message):boolean {\n        if (this.readyState > 1){\n            return false;\n        }\n        return this.frame(message, 'binary');\n    }\n    public ping(message, callback?):boolean {\n        if (this.readyState > 1){\n            return false;\n        }\n        message = message || '';\n        if (callback){\n            this._pingCallbacks[message] = callback;\n        }\n        return this.frame(message, 'ping');\n    }\n    public pong(message):boolean{\n        if (this.readyState > 1){\n            return false;\n        }\n        message = message || '';\n        return this.frame(message, 'pong');\n    }\n    public close(reason?, code?):boolean{\n        reason = reason || '';\n        code = code || this.ERRORS.normal_closure;\n\n        if (this.readyState <= 0) {\n            this.readyState = 3;\n            this.emit('close', new Base.CloseEvent(code, reason));\n            return true;\n        } else if (this.readyState === 1) {\n            this.readyState = 2;\n            this._extensions.close(function () {\n                this.frame(reason, 'close', code)\n            }, this);\n            return true;\n        } else {\n            return false;\n        }\n    }\n    public frame(buffer, type?, code?) {\n        if (this.readyState <= 0) return this._queue([buffer, type, code]);\n        if (this.readyState > 2) return false;\n\n        if (Array.isArray(buffer)) buffer = new Buffer(buffer);\n        if (typeof buffer === 'number'){\n            buffer = buffer.toString();\n        }\n\n        let message = new Message(),\n            isText = (typeof buffer === 'string'),\n            payload, copy;\n\n        message.rsv1 = message.rsv2 = message.rsv3 = false;\n        message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n\n        payload = isText ? new Buffer(buffer, 'utf8') : buffer;\n\n        if (code) {\n            copy = payload;\n            payload = new Buffer(2 + copy.length);\n            payload.writeUInt16BE(code, 0);\n            copy.copy(payload, 2);\n        }\n        message.data = payload;\n\n        let onMessageReady = (message)=> {\n            let frame = new Frame();\n\n            frame.final = true;\n            frame.rsv1 = message.rsv1;\n            frame.rsv2 = message.rsv2;\n            frame.rsv3 = message.rsv3;\n            frame.opcode = message.opcode;\n            frame.masked = !!this._masking;\n            frame.length = message.data.length;\n            frame.payload = message.data;\n\n            if (frame.masked) {\n                frame.maskingKey = randomBytes(4);\n            }\n\n            this._sendFrame(frame);\n        };\n\n        if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0){\n            //onMessageReady(message);\n            this._extensions.processOutgoingMessage(message, function (error, message) {\n                if (error) {\n                    return this._fail('extension_error', error.message);\n                }\n                onMessageReady(message);\n            }, this);\n        } else {\n            onMessageReady(message);\n        }\n        return true;\n    }\n\n    protected _sendFrame(frame) {\n        let length = frame.length,\n            header = (length <= 125) ? 2 : (length <= 65535 ? 4 : 10),\n            offset = header + (frame.masked ? 4 : 0),\n            buffer = new Buffer(offset + length),\n            masked = frame.masked ? this.MASK : 0;\n\n        buffer[0] = (frame.final ? this.FIN : 0) |\n            (frame.rsv1 ? this.RSV1 : 0) |\n            (frame.rsv2 ? this.RSV2 : 0) |\n            (frame.rsv3 ? this.RSV3 : 0) |\n            frame.opcode;\n\n        if (length <= 125) {\n            buffer[1] = masked | length;\n        } else if (length <= 65535) {\n            buffer[1] = masked | 126;\n            buffer.writeUInt16BE(length, 2);\n        } else {\n            buffer[1] = masked | 127;\n            buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n            buffer.writeUInt32BE(length % 0x100000000, 6);\n        }\n\n        frame.payload.copy(buffer, offset);\n\n        if (frame.masked) {\n            frame.maskingKey.copy(buffer, header);\n            Hybi.mask(buffer, frame.maskingKey, offset);\n        }\n        //console.info(\">>>\", createHash('md5').update(buffer).digest(\"hex\"), buffer);\n        this._write(buffer);\n    }\n    protected _handshakeResponse():any {\n        let extensions;\n        try {\n             extensions = this._extensions.generateResponse(\n                 this._request.headers['sec-websocket-extensions']\n             );\n        } catch (e) {\n            return this._fail('protocol_error', e.message);\n        }\n        if (extensions){\n            this._headers.set('Sec-WebSocket-Extensions', extensions);\n        }\n        let start = 'HTTP/1.1 101 Switching Protocols';\n        let headers = [start, this._headers.toString(), ''];\n        return new Buffer(headers.join('\\r\\n'), 'utf8');\n    }\n    protected _shutdown(code, reason, error?) {\n        delete this._frame;\n        delete this._message;\n        this._stage = 5;\n\n        let sendCloseFrame = (this.readyState === 1);\n        this.readyState = 2;\n\n        this._extensions.close(function () {\n            if (sendCloseFrame) this.frame(reason, 'close', code);\n            this.readyState = 3;\n            if (error) this.emit('error', new Error(reason));\n            this.emit('close', new Base.CloseEvent(code, reason));\n        }, this);\n    }\n    protected _fail(type, message) {\n        if (this.readyState > 1) return;\n        this._shutdown(this.ERRORS[type], message, true);\n    }\n    protected _parseOpcode(octet) {\n        let rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function (rsv) {\n            return (octet & rsv) === rsv;\n        });\n\n        let frame = this._frame = new Frame();\n\n        frame.final = (octet & this.FIN) === this.FIN;\n        frame.rsv1 = rsvs[0];\n        frame.rsv2 = rsvs[1];\n        frame.rsv3 = rsvs[2];\n        frame.opcode = (octet & this.OPCODE);\n\n        this._stage = 1;\n\n        if (!this._extensions.validFrameRsv(frame))\n            return this._fail('protocol_error',\n                'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) +\n                ', reserved2 = ' + (frame.rsv2 ? 1 : 0) +\n                ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n\n        if (this.OPCODE_CODES.indexOf(frame.opcode) < 0)\n            return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n\n        if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final)\n            return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n\n        if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0)\n            return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n    }\n    protected _parseLength(octet) {\n        let frame = this._frame;\n        frame.masked = (octet & this.MASK) === this.MASK;\n        frame.length = (octet & this.LENGTH);\n\n        if (frame.length >= 0 && frame.length <= 125) {\n            this._stage = frame.masked ? 3 : 4;\n            if (!this._checkFrameLength()) return;\n        } else {\n            this._stage = 2;\n            frame.lengthBytes = (frame.length === 126 ? 2 : 8);\n        }\n\n        if (this._requireMasking && !frame.masked)\n            return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n    }\n    protected _parseExtendedLength(buffer) {\n        let frame = this._frame;\n        frame.length = this._readUInt(buffer);\n\n        this._stage = frame.masked ? 3 : 4;\n\n        if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125)\n            return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n\n        if (!this._checkFrameLength()) return;\n    }\n    protected _checkFrameLength() {\n        let length = this._message ? this._message.length : 0;\n\n        if (length + this._frame.length > this._maxLength) {\n            this._fail('too_large', 'WebSocket frame length too large');\n            return false;\n        } else {\n            return true;\n        }\n    }\n    protected _emitFrame(buffer) {\n        let frame = this._frame,\n            payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n            opcode = frame.opcode,\n            message,\n            code, reason,\n            callbacks, callback;\n\n        delete this._frame;\n\n        if (opcode === this.OPCODES.continuation) {\n            if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n            this._message.pushFrame(frame);\n        }\n\n        if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n            this._message = new Message();\n            this._message.pushFrame(frame);\n        }\n\n        if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0)\n            return this._emitMessage(this._message);\n\n        if (opcode === this.OPCODES.close) {\n            code = (payload.length >= 2) ? payload.readUInt16BE(0) : null;\n            reason = (payload.length > 2) ? this._encode(payload.slice(2)) : null;\n\n            if (!(payload.length === 0) && !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) &&\n                this.ERROR_CODES.indexOf(code) < 0)\n                code = this.ERRORS.protocol_error;\n\n            if (payload.length > 125 || (payload.length > 2 && !reason))\n                code = this.ERRORS.protocol_error;\n\n            this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n        }\n\n        if (opcode === this.OPCODES.ping) {\n            this.frame(payload, 'pong');\n        }\n\n        if (opcode === this.OPCODES.pong) {\n            callbacks = this._pingCallbacks;\n            message = this._encode(payload);\n            callback = callbacks[message];\n\n            delete callbacks[message];\n            if (callback) callback()\n        }\n    }\n    protected _emitMessage(message) {\n        message = this._message;\n        message.read();\n        delete this._message;\n        this._extensions.processIncomingMessage(message, function (error, message) {\n            if (error){\n                return this._fail('extension_error', error.message);\n            }\n            let payload = message.data;\n            if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n            if (payload === null)\n                return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');\n            else\n                this.emit('message', new Base.MessageEvent(payload));\n        }, this);\n    }\n    protected _encode(buffer) {\n        try {\n            let string = buffer.toString('binary', 0, buffer.length);\n            if (!this.UTF8_MATCH.test(string)) return null;\n        } catch (e) {\n        }\n        return buffer.toString('utf8', 0, buffer.length);\n    }\n    protected _readUInt(buffer) {\n        if (buffer.length === 2) return buffer.readUInt16BE(0);\n\n        return buffer.readUInt32BE(0) * 0x100000000 +\n            buffer.readUInt32BE(4);\n    }\n}\n"]}