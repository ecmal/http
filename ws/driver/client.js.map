{"version":3,"file":"client.js","sourceRoot":"","sources":["client.ts"],"names":[],"mappings":"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","sourcesContent":["import * as url from 'node/url';\nimport * as crypto from 'node/crypto';\n\nimport {Hybi} from \"./hybi\";\nimport {Base} from \"./base\";\nimport {Proxy} from \"./proxy\";\nimport {HttpParser} from \"./http_parser\";\n\n\nexport class Client extends Hybi {\n    static generateKey() {\n        return crypto.randomBytes(16).toString('base64');\n    }\n    public version:string;\n    public _key:string;\n    public _pathname:string;\n    public _protocols:string[];\n    public _accept:string;\n    public _http:HttpParser;\n    public VALID_PROTOCOLS = ['ws:', 'wss:'];\n    public statusCode:number;\n    public headers:number;\n\n    constructor(_url, options) {\n        super(null, _url, (()=>{\n            options = options || {};\n            if (options.masking === undefined){\n                options.masking = true;\n            }\n            return options;\n        })());\n        this.version = 'hybi-13';\n        this.readyState = -1;\n        this._key       = Client.generateKey();\n        this._accept    = Hybi.generateAccept(this._key);\n        this._http      = new HttpParser('response');\n        var uri  = url.parse(this.url),\n            auth = uri.auth && new Buffer(uri.auth, 'utf8').toString('base64');\n\n        if (this.VALID_PROTOCOLS.indexOf(uri.protocol) < 0)\n            throw new Error(this.url + ' is not a valid WebSocket URL');\n\n        this._pathname = (uri.pathname || '/') + (uri.search || '');\n\n        this._headers.set('Host', uri.host);\n        this._headers.set('Upgrade', 'websocket');\n        this._headers.set('Connection', 'Upgrade');\n        this._headers.set('Sec-WebSocket-Key', this._key);\n        this._headers.set('Sec-WebSocket-Version', '13');\n\n        if (this._protocols.length > 0)\n            this._headers.set('Sec-WebSocket-Protocol', this._protocols.join(', '));\n\n        if (auth)\n            this._headers.set('Authorization', 'Basic ' + auth);\n    }\n\n    public proxy(origin, options) {\n        return new Proxy(this, origin, options);\n    }\n    public start() {\n        if (this.readyState !== -1) return false;\n        this._write(this._handshakeRequest());\n        this.readyState = 0;\n        return true;\n    }\n    public parse(chunk) {\n        if (this.readyState === 3) return;\n        if (this.readyState > 0) return Hybi.prototype.parse.call(this, chunk);\n\n        this._http.parse(chunk);\n        if (!this._http.isComplete()) return;\n\n        this._validateHandshake();\n        if (this.readyState === 3) return;\n\n        this._open();\n        this.parse(this._http.body);\n    }\n\n    protected _handshakeRequest() {\n        var extensions = this._extensions.generateOffer();\n        if (extensions)\n            this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n        var start   = 'GET ' + this._pathname + ' HTTP/1.1',\n            headers = [start, this._headers.toString(), ''];\n\n        return new Buffer(headers.join('\\r\\n'), 'utf8');\n    }\n    protected _failHandshake(message) {\n        message = 'Error during WebSocket handshake: ' + message;\n        this.readyState = 3;\n        this.emit('error', new Error(message));\n        this.emit('close', new Base.CloseEvent(this.ERRORS.protocol_error, message));\n    }\n    protected _validateHandshake() {\n        this.statusCode = this._http.statusCode;\n        this.headers    = this._http.headers;\n\n        if (this._http.statusCode !== 101)\n            return this._failHandshake('Unexpected response code: ' + this._http.statusCode);\n\n        var headers    = this._http.headers,\n            upgrade    = headers['upgrade'] || '',\n            connection = headers['connection'] || '',\n            accept     = headers['sec-websocket-accept'] || '',\n            protocol   = headers['sec-websocket-protocol'] || '';\n\n        if (upgrade === '')\n            return this._failHandshake(\"'Upgrade' header is missing\");\n        if (upgrade.toLowerCase() !== 'websocket')\n            return this._failHandshake(\"'Upgrade' header value is not 'WebSocket'\");\n\n        if (connection === '')\n            return this._failHandshake(\"'Connection' header is missing\");\n        if (connection.toLowerCase() !== 'upgrade')\n            return this._failHandshake(\"'Connection' header value is not 'Upgrade'\");\n\n        if (accept !== this._accept)\n            return this._failHandshake('Sec-WebSocket-Accept mismatch');\n\n        this.protocol = null;\n\n        if (protocol !== '') {\n            if (this._protocols.indexOf(protocol) < 0)\n                return this._failHandshake('Sec-WebSocket-Protocol mismatch');\n            else\n                this.protocol = protocol;\n        }\n\n        try {\n            this._extensions.activate(this.headers['sec-websocket-extensions']);\n        } catch (e) {\n            return this._failHandshake(e.message);\n        }\n    }\n}\n\n"]}