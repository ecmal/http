{"version":3,"file":"pipeline.js","sourceRoot":"","sources":["pipeline.ts"],"names":[],"mappings":"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","sourcesContent":["import {Cell} from \"./pipeline/cell\"\nimport {Pledge} from \"./pipeline/pledge\"\n\nexport class Pipeline {\n  private _cells;\n  private _stopped;\n  public constructor(sessions) {\n    this._cells   = sessions.map((session)=>{\n        return new Cell(session)\n    });\n    this._stopped = {\n      incoming : false,\n      outgoing : false\n    };\n  }\n  public processIncomingMessage(message, callback, context) {\n    //console.info('incoming',message.opcode,message.length);\n    if (this._stopped.incoming){\n      return;\n    }\n    this._loop('incoming', this._cells.length - 1, -1, -1, message, callback, context);\n  }\n  public processOutgoingMessage(message, callback, context) {\n    //console.info('outgoing',message.opcode,message.length);\n    if (this._stopped.outgoing){\n      return;\n    }\n    this._loop('outgoing', 0, this._cells.length, 1, message, callback, context);\n  }\n  public close(callback, context) {\n    this._stopped = {incoming: true, outgoing: true};\n    var closed = this._cells.map(function(a) { return a.close() });\n    if (callback) {\n      Pledge.all(closed).then(function () {\n        callback.call(context)\n      });\n    }\n  }\n  protected _loop (direction, start, end, step, message, callback, context) {\n    let cells = this._cells,n=cells.length;\n    while (n--){\n      cells[n].pending(direction);\n    }\n    let pipe = (index, error, msg)=>{\n      if (index === end){\n        return callback.call(context, error, msg);\n      }\n      cells[index][direction](error, msg, (err, m)=>{\n        if (err) {\n          this._stopped[direction] = true;\n        }\n        pipe(index + step, err, m);\n      });\n    };\n    pipe(start, null, message);\n  }\n}\n\n"]}