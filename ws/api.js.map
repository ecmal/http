{"version":3,"file":"api.js","sourceRoot":"","sources":["api.ts"],"names":[],"mappings":"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","sourcesContent":["import {Stream} from \"node/stream\";\nimport {Driver} from \"./driver\";\nimport {Base} from \"./driver/base\";\nimport {Event} from \"./events\";\nimport {EventTarget} from \"./events\";\n\n\nexport class API extends Stream implements EventTarget {\n\n    static CONNECTING = 0;\n    static OPEN = 1;\n    static CLOSING = 2;\n    static CLOSED = 3;\n\n    public readable:boolean;\n    public writable:boolean;\n    public readyState;\n    public bufferedAmount;\n    public protocol;\n    public url;\n    public version;\n\n    protected _driver:Base;\n    protected _ping;\n    protected _pingId;\n    protected _pingTimer;\n    protected _proxy;\n    protected _stream;\n    protected _closeParams;\n\n    constructor(options?) {\n        super();\n        if(options){\n            this._configureApi(options);\n        }\n    }\n\n    public write(data) {\n        return this.send(data);\n    }\n    public end(data) {\n        if (data !== undefined) this.send(data);\n        this.close();\n    }\n    public pause() {\n        return this._driver.messages.pause();\n    }\n    public resume() {\n        return this._driver.messages.resume();\n    }\n    public send(data) {\n        if (this.readyState > API.OPEN) return false;\n        if (!Buffer.isBuffer(data)){\n            data = String(data);\n        }\n        return this._driver.messages.write(data);\n    }\n    public ping(message, callback?) {\n        if (this.readyState > API.OPEN) return false;\n        return this._driver.ping(message, callback);\n    }\n    public close(code?, reason?) {\n        if (code === undefined) code = 1000;\n        if (reason === undefined) reason = '';\n\n        if (code !== 1000 && (code < 3000 || code > 4999))\n            throw new Error(\"Failed to execute 'close' on WebSocket: \" +\n                \"The code must be either 1000, or between 3000 and 4999. \" +\n                code + \" is neither.\");\n        if (this.readyState !== API.CLOSED) this.readyState = API.CLOSING;\n        this._driver.close(reason, code);\n    }\n\n    public onopen    : (event)=>void  = null;\n    public onmessage : (event)=>void  = null;\n    public onerror   : (event)=>void  = null;\n    public onclose   : (event)=>void  = null;\n\n    public addEventListener(eventType, listener, useCapture) {\n        this['on'](eventType, listener);\n    }\n    public removeEventListener(eventType, listener, useCapture) {\n        this['off'](eventType, listener);\n    }\n    public dispatchEvent(event) {\n        event.target = event.currentTarget = this;\n        event.eventPhase = Event.AT_TARGET;\n        if (this['on' + event.type])\n            this['on' + event.type](event);\n        this['emit'](event.type, event);\n    }\n\n    protected _configureApi(options) {\n        Driver.validateOptions(options, [\n            'headers', 'extensions', 'maxLength', 'ping', 'proxy', 'tls', 'ca'\n        ]);\n        this.readable = this.writable = true;\n        this._ping = options.ping;\n        this._pingId = 0;\n        this.readyState = API.CONNECTING;\n        this.bufferedAmount = 0;\n        this.protocol = '';\n        this.url = this._driver.url;\n        this.version = this._driver.version;\n        this._driver.on('open', (e)=> {\n            this._open()\n        });\n        this._driver.on('message', (e)=> {\n            this._receiveMessage(e.data)\n        });\n        this._driver.on('close', (e)=> {\n            this._beginClose(e.reason, e.code)\n        });\n        this._driver.on('error', (e)=> {\n            this._emitError(e.message);\n        });\n        this._driver.messages.on('drain',()=>{this.emit('drain')});\n\n        var headers = options.headers;\n        if (headers) {\n            for (var name in headers) {\n                this._driver.setHeader(name, headers[name]);\n            }\n        }\n\n        var extensions = options.extensions;\n        if (extensions) {\n            extensions.forEach(e=> {\n                this._driver.addExtension(e)\n            });\n        }\n\n        this.on('error', function () {\n        });\n\n        if (this._ping)\n            this._pingTimer = setInterval(()=>{\n                this._pingId += 1;\n                this.ping(this._pingId.toString());\n            }, this._ping * 1000);\n\n        this._configureStream();\n\n        if (!this._proxy) {\n            this._stream.pipe(this._driver.io);\n            this._driver.io.pipe(this._stream);\n        }\n    }\n    protected _configureStream() {\n        var self = this;\n\n        this._stream.setTimeout(0);\n        this._stream.setNoDelay(true);\n\n        ['close', 'end'].forEach(function (event) {\n            this._stream.on(event, function () {\n                self._finalizeClose()\n            });\n        }, this);\n\n        this._stream.on('error', function (error) {\n            self._emitError('Network error: ' + self.url + ': ' + error.message);\n            self._finalizeClose();\n        });\n    }\n    protected _open() {\n        if (this.readyState !== API.CONNECTING) return;\n\n        this.readyState = API.OPEN;\n        this.protocol = this._driver.protocol || '';\n\n        var event = new Event('open');\n        event.initEvent('open', false, false);\n        this.dispatchEvent(event);\n    }\n    protected _receiveMessage(data) {\n        if (this.readyState > API.OPEN) return false;\n        if (this.readable) this.emit('data', data);\n\n        var event = new Event('message', {data: data});\n        event.initEvent('message', false, false);\n        this.dispatchEvent(event);\n    }\n    protected _emitError(message) {\n        if (this.readyState >= API.CLOSING) return;\n\n        var event = new Event('error', {message: message});\n        event.initEvent('error', false, false);\n        this.dispatchEvent(event);\n    }\n    protected _beginClose(reason, code) {\n        if (this.readyState === API.CLOSED) return;\n        this.readyState = API.CLOSING;\n        this._closeParams = [reason, code];\n\n        if (this._stream) {\n            this._stream.end();\n            if (!this._stream.readable) this._finalizeClose();\n        }\n    }\n    protected _finalizeClose() {\n        if (this.readyState === API.CLOSED) return;\n        this.readyState = API.CLOSED;\n\n        if (this._pingTimer) clearInterval(this._pingTimer);\n        if (this._stream) this._stream.end();\n\n        if (this.readable) this.emit('end');\n        this.readable = this.writable = false;\n\n        var reason = this._closeParams ? this._closeParams[0] : '',\n            code = this._closeParams ? this._closeParams[1] : 1006;\n\n        var event = new Event('close', {code: code, reason: reason});\n        event.initEvent('close', false, false);\n        this.dispatchEvent(event);\n    }\n}\n\n\n\n\n"]}