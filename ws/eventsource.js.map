{"version":3,"file":"eventsource.js","sourceRoot":"","sources":["eventsource.ts"],"names":[],"mappings":"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","sourcesContent":["import {Stream} from \"node/stream\";\nimport {Driver} from \"./driver\";\nimport {Headers} from \"./driver/headers\";\nimport {API} from \"./api\";\nimport {EventTarget} from \"./events\";\nimport {Event} from \"./events\";\n\nexport class EventSource extends Stream implements EventTarget {\n    static isEventSource(request) {\n        if (request.method !== 'GET'){\n            return false;\n        }\n        var accept = (request.headers.accept || '').split(/\\s*,\\s*/);\n        return accept.indexOf('text/event-stream') >= 0;\n    }\n    public writable:boolean;\n    public url:string;\n    public lastEventId:string;\n    public readyState:number;\n\n    public DEFAULT_PING  = 10;\n    public DEFAULT_RETRY = 5;\n\n    public onopen    : (event)=>void  = null;\n    public onmessage : (event)=>void  = null;\n    public onerror   : (event)=>void  = null;\n    public onclose   : (event)=>void  = null;\n\n    protected _stream:any;\n    protected _ping:number;\n    protected _pingTimer:any;\n    protected _retry:number;\n\n    public constructor(request, response, options) {\n        super();\n        this.writable = true;\n        options = options || {};\n\n        this._stream = response.socket;\n        this._ping = options.ping || this.DEFAULT_PING;\n        this._retry = options.retry || this.DEFAULT_RETRY;\n\n        var scheme = Driver.isSecureRequest(request) ? 'https:' : 'http:';\n        this.url = scheme + '//' + request.headers.host + request.url;\n        this.lastEventId = request.headers['last-event-id'] || '';\n        this.readyState = API.CONNECTING;\n\n        var headers = new Headers();\n\n        if (options.headers) {\n            for (var key in options.headers) {\n                headers.set(key, options.headers[key]);\n            }\n        }\n\n        if (!this._stream || !this._stream.writable) {\n            return;\n        }\n        system.node.process.nextTick(()=> {\n            this._open()\n        });\n\n        this._stream.setTimeout(0);\n        this._stream.setNoDelay(true);\n\n        var handshake = 'HTTP/1.1 200 OK\\r\\n' +\n            'Content-Type: text/event-stream\\r\\n' +\n            'Cache-Control: no-cache, no-store\\r\\n' +\n            'Connection: close\\r\\n' +\n            headers.toString() +\n            '\\r\\n' +\n            'retry: ' + Math.floor(this._retry * 1000) + '\\r\\n\\r\\n';\n\n        this._write(handshake);\n\n        this._stream.on('drain', ()=>{this.emit('drain')});\n\n        if (this._ping) {\n            this._pingTimer = setInterval(()=> {\n                this.ping()\n            }, this._ping * 1000);\n        }\n\n        ['error', 'end'].forEach((event)=> {\n            this._stream.on(event,()=>{\n                this.close()\n            });\n        });\n    }\n    public addEventListener(eventType, listener, useCapture) {\n        this['on'](eventType, listener);\n    }\n    public removeEventListener(eventType, listener, useCapture) {\n        this['off'](eventType, listener);\n    }\n    public dispatchEvent(event) {\n        event.target = event.currentTarget = this;\n        event.eventPhase = Event.AT_TARGET;\n        if (this['on' + event.type])\n            this['on' + event.type](event);\n        this['emit'](event.type, event);\n    }\n    public write(message) {\n        return this.send(message);\n    }\n    public end(message) {\n        if (message !== undefined) this.write(message);\n        this.close();\n    }\n    public send(message, options?) {\n        if (this.readyState > API.OPEN) return false;\n\n        message = String(message).replace(/(\\r\\n|\\r|\\n)/g, '$1data: ');\n        options = options || {};\n\n        var frame = '';\n        if (options.event) frame += 'event: ' + options.event + '\\r\\n';\n        if (options.id)    frame += 'id: '    + options.id    + '\\r\\n';\n        frame += 'data: ' + message + '\\r\\n\\r\\n';\n\n        return this._write(frame);\n    }\n    public ping() {\n        return this._write(':\\r\\n\\r\\n');\n    }\n    public close() {\n        if (this.readyState > API.OPEN) return false;\n\n        this.readyState = API.CLOSED;\n        this.writable = false;\n        if (this._pingTimer) clearInterval(this._pingTimer);\n        if (this._stream) this._stream.end();\n\n        var event = new Event('close');\n        event.initEvent('close', false, false);\n        this.dispatchEvent(event);\n\n        return true;\n    }\n    protected _write(chunk) {\n    if (!this.writable) return false;\n    try {\n        return this._stream.write(chunk, 'utf8');\n    } catch (e) {\n        return false;\n    }\n}\n    protected _open() {\n    if (this.readyState !== API.CONNECTING) return;\n\n    this.readyState = API.OPEN;\n\n    var event = new Event('open');\n    event.initEvent('open', false, false);\n    this.dispatchEvent(event);\n}\n}\n\n\n\nmodule.exports = EventSource;"]}